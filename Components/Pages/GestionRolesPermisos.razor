@page "/Gestion_roles_permisos"
@using PruebaLogin.Models.Roles
@using PruebaLogin.Models.Permisos
@using PruebaLogin.ViewModels.RolController
@using PruebaLogin.ViewModels.PermissionController
@using PruebaLogin.ViewModels.RPController
@inject RolService _rolService
@inject PermisoService _permisoService
@inject RolPermisoService _rolPermisoService

<h3>Gestión de Roles y Permisos</h3>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Id</th>
            <th>Nombre del Rol</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var rol in roles)
        {
            <tr>
                <td>@rol.IdRol</td>
                <td>@rol.NombreRol</td>
                <td>
                    <button class="btn btn-primary btn-sm" @onclick="() => MostrarPermisos(rol.IdRol)">
                        Asignar Permisos
                    </button>
                </td>
            </tr>
            @if (rol.IdRol == rolSeleccionadoId)
            {
                <tr>
                    <td colspan="3">
                        <h5>Permisos para: @rol.NombreRol</h5>
                        <div class="form-check form-switch" style="margin-left:20px;">
                            @foreach (var permiso in permisos)
                            {
                                bool asignado = permisosSeleccionados.Contains(permiso.IdPermiso);
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="permiso_@permiso.IdPermiso"
                                           checked="@asignado"
                                           @onchange="(e) => TogglePermisoLocal(permiso.IdPermiso, (bool)e.Value)" />
                                    <label class="form-check-label" for="permiso_@permiso.IdPermiso">
                                        @permiso.NombrePermiso
                                    </label>
                                </div>
                            }
                        </div>
                        <button class="btn btn-success mt-3" @onclick="GuardarCambios">Guardar cambios</button>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger mt-3">@mensajeError</div>
}
@if (!string.IsNullOrEmpty(mensajeExito))
{
    <div class="alert alert-success mt-3">@mensajeExito</div>
}

@code {
    private List<Roles2> roles = new();
    private List<Permisos2> permisos = new();
    private HashSet<int> permisosSeleccionados = new();

    private int rolSeleccionadoId;

    private string mensajeError;
    private string mensajeExito;

    protected override async Task OnInitializedAsync()
    {
        roles = await _rolService.ObtenerTodosRolesAsync();
        permisos = await _permisoService.ObtenerTodosPermisosAsync();
    }

    private async Task MostrarPermisos(int idRol)
    {
        rolSeleccionadoId = idRol;
        var permisosDelRol = await _rolPermisoService.ObtenerPermisosPorRolAsync(idRol);
        permisosSeleccionados = permisosDelRol.Select(p => p.IdPermiso).ToHashSet();
    }

    // Cambia solo en memoria local
    private void TogglePermisoLocal(int idPermiso, bool asignar)
    {
        if (asignar)
            permisosSeleccionados.Add(idPermiso);
        else
            permisosSeleccionados.Remove(idPermiso);
    }

    // Aplica cambios en la base de datos al presionar Guardar
    private async Task GuardarCambios()
    {
        if (rolSeleccionadoId == 0)
        {
            mensajeError = "Debes seleccionar un rol.";
            mensajeExito = string.Empty;
            return;
        }

        // Obtener permisos actuales en BD
        var permisosActuales = await _rolPermisoService.ObtenerPermisosPorRolAsync(rolSeleccionadoId);
        var idsActuales = permisosActuales.Select(p => p.IdPermiso).ToHashSet();

        // Permisos a agregar
        var agregar = permisosSeleccionados.Except(idsActuales);
        foreach (var idPermiso in agregar)
        {
            await _rolPermisoService.AsignarPermisoARolAsync(rolSeleccionadoId, idPermiso);
        }

        // Permisos a eliminar
        var eliminar = idsActuales.Except(permisosSeleccionados);
        foreach (var idPermiso in eliminar)
        {
            await _rolPermisoService.EliminarPermisoDeRolAsync(rolSeleccionadoId, idPermiso);
        }

        mensajeExito = "Cambios guardados correctamente.";
        mensajeError = string.Empty;
    }
}
