@page "/usuarios-list"
@using PruebaLogin.Models.User
@using PruebaLogin.Models.Roles
@using PruebaLogin.Models.Data
@using PruebaLogin.ViewModels.PUsuariosController
@using PruebaLogin.ViewModels.RolController
@inject UsuarioController _userController
@inject RolService _rolService
@inject NavigationManager navManagers

<h2>Gestión de Usuarios</h2>

@if (cargando)
{
    <div class="text-center mt-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando usuarios, por favor espera...</p>
    </div>
}
else if (!usuarios.Any())
{
    <p><em>No hay usuarios registrados.</em></p>
}
else
{
    <div class="text-center mb-3">
        <button class="btn btn-success" @onclick="AgregarUsuario">Agregar</button>
    </div>
    <table class="table table-striped table-hover table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th scope="col">Usuario</th>
                <th scope="col">Nombre</th>
                <th scope="col">Email</th>
                <th scope="col">Estado</th>
                <th scope="col">Rol</th>
                <th scope="col">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var usuario in usuarios)
            {
                <tr>
                    <td>@usuario.UserName</td>
                    <td>@usuario.Nombre</td>
                    <td>@usuario.Email</td>
                    <td>@(usuario.Activo ? "Activo" : "Inactivo")</td>
                    <td>@usuario.Rol?.NombreRol</td>
                    <td>
                        <button class="btn btn-warning btn-sm me-1" 
                                @onclick="() => MostrarFormularioEdicion(usuario)"
                                disabled="@guardando">
                            Editar
                        </button>
                        <button class="btn @(usuario.Activo ? "btn-secondary" : "btn-success") btn-sm"
                                @onclick="() => CambiarEstado(usuario.Id)"
                                disabled="@guardando">
                            @(usuario.Activo ? "Desactivar" : "Activar")
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (usuarioEditando != null)
{
    <div class="card mt-3 shadow">
        <div class="card-body">
            <h5 class="card-title">Editar Usuario</h5>
            <EditForm Model="usuarioEditando" OnValidSubmit="AplicarCambios">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger mb-3" />

                <div class="form-floating mb-3">
                    <InputText class="form-control" id="nombre" @bind-Value="usuarioEditando.Nombre" />
                    <label for="nombre">Nombre Completo</label>
                    <ValidationMessage For="@(() => usuarioEditando.Nombre)" />
                </div>

                <div class="form-floating mb-3">
                    <InputText class="form-control" id="userName" @bind-Value="usuarioEditando.UserName" />
                    <label for="userName">Usuario</label>
                    <ValidationMessage For="@(() => usuarioEditando.UserName)" />
                </div>

                <div class="form-floating mb-3">
                    <InputText class="form-control" id="email" type="email" @bind-Value="usuarioEditando.Email" />
                    <label for="email">Correo Electrónico</label>
                    <ValidationMessage For="@(() => usuarioEditando.Email)" />
                </div>

                <div class="form-floating mb-3">
                    <select class="form-select" id="rolSelect" @bind="usuarioEditando.IdRol">
                        <option value="">-- Selecciona un Rol --</option>
                        @foreach (var rol in roles)
                        {
                            <option value="@rol.IdRol">@rol.NombreRol</option>
                        }
                    </select>
                    <label for="rolSelect">Rol</label>
                    <ValidationMessage For="@(() => usuarioEditando.IdRol)" />
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@guardando">
                        @if (guardando)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span>Aplicar Cambios</span>
                        }
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="Cancelar" disabled="@guardando">
                        Cancelar
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private List<Usuarios2> usuarios = new();
    private Usuarios2 usuarioEditando;
    private List<Roles2> roles = new();
    private string mensajeError;
    private string mensajeExito;
    private bool guardando = false;
    private bool cargando = true; // bandera para mostrar spinner

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Mostrar spinner durante 2 segundos
            await Task.Delay(2000);

            usuarios = await _userController.ObtenerTodosUsuariosAsyng() ?? new List<Usuarios2>();
            roles = await _rolService.ObtenerTodosRolesAsync();

            cargando = false; // ocultar spinner
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar usuarios: {ex.Message}";
            cargando = false;
        }
    }

    private void MostrarFormularioEdicion(Usuarios2 usuario)
    {
        usuarioEditando = new Usuarios2
        {
            Id = usuario.Id,
            Nombre = usuario.Nombre,
            UserName = usuario.UserName,
            Email = usuario.Email,
            IdRol = usuario.IdRol,
        };
    }

    private async Task AplicarCambios()
    {
        guardando = true;
        mensajeError = null;
        mensajeExito = null;

        try
        {
            var resultado = await _userController.ActualizarUsuarioASyng(usuarioEditando);

            if (resultado.Exito)
            {
                mensajeExito = "Usuario actualizado correctamente.";
                usuarioEditando = null;

                cargando = true;
                await Task.Delay(1000); // delay antes de recargar
                usuarios = await _userController.ObtenerTodosUsuariosAsyng();
                cargando = false;
            }
            else
            {
                mensajeError = resultado.Error;
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error inesperado: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    private void Cancelar()
    {
        usuarioEditando = null;
    }

    private async Task CambiarEstado(Guid id)
    {
        var resultado = await _userController.CambiarEstadoUsuario(id);
        if (resultado.Exito)
        {
            mensajeExito = "Estado del usuario actualizado.";
            mensajeError = string.Empty;

            cargando = true;
            await Task.Delay(1000); // delay antes de recargar
            usuarios = await _userController.ObtenerTodosUsuariosAsyng();
            cargando = false;
        }
        else
        {
            mensajeError = resultado.Error;
            mensajeExito = string.Empty;
        }
    }

    private void AgregarUsuario()
    {
        navManagers.NavigateTo("/usuarios");
    }
}
